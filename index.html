<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f97316">
<title>Mustang PM Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f10; --surface: #151719; --surface2: #1c1f22; --border: #2a2e32;
    --orange: #f97316; --orange-dim: #7c3a0e; --red: #ef4444; --red-dim: #450a0a;
    --yellow: #eab308; --yellow-dim: #422006; --green: #22c55e; --green-dim: #052e16;
    --blue: #3b82f6; --blue-dim: #1e3a5f;
    --text: #e2e8f0; --text-dim: #64748b; --text-mid: #94a3b8;
    --font-display: 'Rajdhani', sans-serif; --font-mono: 'Share Tech Mono', monospace; --font-body: 'Barlow', sans-serif;
  }
  body.light-mode {
    --bg: #f0f2f5; --surface: #ffffff; --surface2: #e8eaed; --border: #c8cdd4;
    --orange: #e06010; --orange-dim: #fde8d8; --red: #dc2626; --red-dim: #fee2e2;
    --yellow: #b45309; --yellow-dim: #fef9c3; --green: #16a34a; --green-dim: #dcfce7;
    --blue: #2563eb; --blue-dim: #dbeafe;
    --text: #1e2530; --text-dim: #64748b; --text-mid: #475569;
  }
  body.light-mode .task-card.overdue { background: #fee2e2; }
  body.light-mode .task-card.due-soon { background: #fef9c3; }
  body.light-mode .task-card.never-done { background: #fde8d8; }
  body.light-mode .task-card.critical { background: #ffc9c9; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 15px; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; overflow-x: hidden; }

  .header { background: var(--surface); border-bottom: 2px solid var(--orange); padding: 8px 16px; display: flex; align-items: center; justify-content: space-between; min-height: 60px; position: sticky; top: 0; z-index: 100; gap: 8px; }
  .logo { font-family: var(--font-display); font-size: clamp(1.1rem, 4vw, 2rem); font-weight: 700; letter-spacing: 2px; color: var(--orange); text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .logo span { color: var(--text-dim); font-weight: 400; }
  .header-right { display: flex; align-items: center; gap: 8px; }
  .overdue-badge { background: var(--red); color: white; font-family: var(--font-display); font-weight: 700; font-size: 0.9rem; padding: 3px 8px; border-radius: 2px; display: none; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

  .device-bar { background: var(--surface2); border-bottom: 1px solid var(--border); padding: 8px 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .bar-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); font-size: 1.2rem; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .bar-btn:hover { border-color: var(--orange); color: var(--orange); }

  .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab { font-family: var(--font-display); font-size: 1rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 12px 20px; border: none; background: none; color: var(--text-dim); cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab.active { color: var(--orange); border-bottom-color: var(--orange); }
  .tab .tab-badge { background: var(--red); color: white; font-size: 0.6rem; padding: 1px 5px; border-radius: 10px; margin-left: 4px; display: none; }

  .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
  .stat { background: var(--surface); padding: 10px 12px; text-align: center; cursor: pointer; }
  .stat:hover { background: var(--surface2); }
  .stat-val { font-family: var(--font-display); font-size: 2rem; font-weight: 700; line-height: 1; }
  .stat-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-top: 2px; }
  .stat-val.red { color: var(--red); } .stat-val.yellow { color: var(--yellow); } .stat-val.green { color: var(--green); } .stat-val.orange { color: var(--orange); }

  .task-list { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
  .task-card { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--border); padding: 16px 18px; cursor: pointer; transition: all 0.15s; }
  .task-card:hover { background: var(--surface2); }
  .task-card.overdue { border-left-color: var(--red); background: #150a0a; }
  .task-card.critical { border-left-color: #ff0000; background: #1f0000; border-left-width: 5px; }
  .task-card.due-soon { border-left-color: var(--yellow); background: #110f06; }
  .task-card.ok { border-left-color: var(--green); }
  .task-card.never-done { border-left-color: var(--orange); background: #110a04; }
  .task-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
  .task-name { font-family: var(--font-display); font-size: 1.25rem; font-weight: 600; letter-spacing: 0.5px; line-height: 1.2; flex: 1; }
  .task-freq { font-family: var(--font-mono); font-size: 0.95rem; color: var(--text-dim); background: var(--surface2); border: 1px solid var(--border); padding: 2px 8px; white-space: nowrap; flex-shrink: 0; }
  .task-bottom { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
  .task-due { font-family: var(--font-mono); font-size: 1rem; }
  .task-due.red { color: var(--red); } .task-due.yellow { color: var(--yellow); } .task-due.green { color: var(--green); } .task-due.orange { color: var(--orange); }
  .task-status-tag { font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 2px 8px; border-radius: 1px; }
  .tag-overdue { background: var(--red-dim); color: var(--red); } .tag-soon { background: var(--yellow-dim); color: var(--yellow); } .tag-ok { background: var(--green-dim); color: var(--green); } .tag-pending { background: var(--orange-dim); color: var(--orange); } .tag-critical { background: #3a0000; color: #ff4444; border: 1px solid #ff0000; }
  .history-count { font-family: var(--font-mono); font-size: 0.88rem; color: var(--text-dim); }
  .last-tech { font-family: var(--font-mono); font-size: 0.88rem; color: var(--text-mid); margin-top: 1px; }
  .task-note-badge { font-family: var(--font-mono); font-size: 0.85rem; color: var(--blue); background: var(--blue-dim); border: 1px solid var(--blue-dim); padding: 1px 6px; margin-top: 3px; display: inline-block; }
  .history-edit-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); font-size: 0.85rem; padding: 2px 7px; cursor: pointer; font-family: var(--font-mono); float: right; margin-top: 2px; }
  .history-edit-btn:hover { border-color: var(--orange); color: var(--orange); }
  .tech-filter-bar { padding: 8px 12px; background: var(--surface2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .tech-filter-bar select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 5px 8px; font-family: var(--font-mono); font-size: 0.85rem; outline: none; flex: 1; }
  .tech-filter-bar select:focus { border-color: var(--orange); }
  .tech-filter-label { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); white-space: nowrap; }
  .btn-pdf { background: var(--red); color: white; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-top: 2px solid var(--orange); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.25s ease; }
  @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header { padding: 16px 16px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
  .modal-title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; letter-spacing: 1px; flex: 1; }
  .modal-close { background: none; border: 1px solid var(--border); color: var(--text-dim); width: 32px; height: 32px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .modal-body { padding: 16px; }
  .modal-info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 1rem; }
  .modal-info-row:last-child { border-bottom: none; }
  .info-label { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
  .info-value { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text); }
  .section-title { font-family: var(--font-display); font-size: 0.95rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); margin: 16px 0 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
  .complete-form { background: var(--surface2); border: 1px solid var(--border); padding: 12px; margin-top: 8px; }
  .form-row { margin-bottom: 10px; }
  label { display: block; font-family: var(--font-mono); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px; }
  input[type="date"], textarea, input[type="text"] { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px 12px; font-family: var(--font-mono); font-size: 1rem; outline: none; transition: border-color 0.15s; }
  input[type="date"]:focus, textarea:focus, input[type="text"]:focus { border-color: var(--orange); }
  textarea { resize: vertical; min-height: 70px; }
  .btn-complete { width: 100%; background: var(--orange); color: #000; border: none; font-family: var(--font-display); font-size: 1.2rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 12px; cursor: pointer; transition: background 0.15s; margin-top: 4px; }
  .btn-complete:hover { background: #fb923c; }

  .history-entry { background: var(--surface2); border: 1px solid var(--border); border-left: 2px solid var(--green); padding: 8px 10px; margin-bottom: 6px; }
  .history-date { font-family: var(--font-mono); font-size: 0.85rem; color: var(--green); margin-bottom: 4px; }
  .history-tech { font-size: 0.9rem; color: var(--text-mid); margin-bottom: 2px; }
  .history-notes { font-size: 0.85rem; color: var(--text-dim); font-style: italic; }
  .no-history { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); text-align: center; padding: 12px; }
  .freq-divider { font-family: var(--font-display); font-size: 0.85rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); padding: 6px 4px 2px; border-bottom: 1px solid var(--border); margin-bottom: 4px; margin-top: 8px; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); font-family: var(--font-mono); font-size: 0.92rem; }
  .next-due-preview { font-family: var(--font-mono); font-size: 0.85rem; color: var(--orange); margin-top: 6px; padding: 4px 8px; background: var(--orange-dim); border: 1px solid var(--orange-dim); }

  .data-panel { margin: 12px; background: var(--surface); border: 1px solid var(--border); border-top: 2px solid var(--blue); padding: 14px; }
  .data-panel-title { font-family: var(--font-display); font-size: 1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--blue); margin-bottom: 12px; }
  .data-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn-data { flex: 1; min-width: 120px; padding: 10px 14px; border: none; cursor: pointer; font-family: var(--font-display); font-size: 0.95rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .btn-export { background: var(--blue); color: white; }
  .btn-import { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .data-note { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); margin-top: 8px; line-height: 1.6; }

  .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--surface2); border: 1px solid var(--border); color: var(--text); font-family: var(--font-mono); font-size: 0.85rem; padding: 10px 20px; z-index: 300; opacity: 0; transition: opacity 0.3s; white-space: nowrap; pointer-events: none; }
  .toast.show { opacity: 1; }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error { border-color: var(--red); color: var(--red); }

  @media print {
    body > *:not(#pdfOverlay) { display: none !important; }
    #pdfOverlay { position: static !important; overflow: visible !important; }
    #pdfOverlay > div:first-child { display: none !important; }
  }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  .manage-panel { padding: 12px; }
  .manage-section { background: var(--surface); border: 1px solid var(--border); border-top: 2px solid var(--orange); padding: 16px; margin-bottom: 12px; }
  .manage-section-title { font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; color: var(--orange); margin-bottom: 12px; }
  .custom-task-item { background: var(--surface2); border: 1px solid var(--border); border-left: 3px solid var(--orange); padding: 10px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .custom-task-info { flex: 1; }
  .custom-task-name { font-family: var(--font-display); font-size: 1.05rem; font-weight: 600; }
  .custom-task-freq { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); margin-top: 2px; }
  .custom-task-btns { display: flex; gap: 6px; flex-shrink: 0; }
  .btn-edit { background: var(--blue-dim); color: var(--blue); border: 1px solid var(--blue-dim); font-family: var(--font-display); font-weight: 700; font-size: 0.8rem; padding: 4px 10px; cursor: pointer; }
  .btn-del { background: var(--red-dim); color: var(--red); border: 1px solid var(--red-dim); font-family: var(--font-display); font-weight: 700; font-size: 0.8rem; padding: 4px 10px; cursor: pointer; }
  .add-pm-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 400; align-items: flex-end; justify-content: center; }
  .add-pm-overlay.open { display: flex; }
  .add-pm-sheet { background: var(--surface); border-top: 2px solid var(--orange); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
  .add-pm-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .add-pm-title { font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; }
  .add-pm-body { padding: 16px; }
  .freq-preview { font-family: var(--font-mono); font-size: 0.85rem; color: var(--orange); background: var(--orange-dim); border: 1px solid var(--orange-dim); padding: 8px 10px; margin: 8px 0 14px; }
</style>
</head>
<body>

<div class="header">
  <div class="logo">Mustang <span>PM Tracker</span></div>
  <div class="header-right">
    <div class="overdue-badge" id="globalOverdueBadge">0 OVERDUE</div>
  </div>
</div>

<div class="device-bar">
  <div id="machineNameDisplay" style="font-family:var(--font-mono);font-size:1.2rem;color:var(--orange);font-weight:700;flex:1;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" onclick="editMachineName()">TAP TO NAME ‚úé</div>
  <button onclick="openAddPMModal(null)" style="background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-weight:700;font-size:0.8rem;padding:5px 10px;cursor:pointer;white-space:nowrap;">+ ADD PM</button>
  <button class="bar-btn" id="lightToggleBtn" onclick="toggleLightMode()">‚òÄ</button>
  <button class="bar-btn" id="fontSizeBtn" onclick="cycleFontSize()">ùêÄ</button>
</div>

<div class="tabs">
  <button class="tab active" onclick="setTab('all')" id="tab-all">All Tasks</button>
  <button class="tab" onclick="setTab('overdue')" id="tab-overdue">Overdue <span class="tab-badge" id="badge-overdue"></span></button>
  <button class="tab" onclick="setTab('due-soon')" id="tab-due-soon">Due Soon <span class="tab-badge" id="badge-soon"></span></button>
  <button class="tab" onclick="setTab('by-date')" id="tab-by-date">By Due Date</button>
  <button class="tab" onclick="setTab('history')" id="tab-history">History</button>
  <button class="tab" onclick="setTab('manage')" id="tab-manage">‚öô Manage PMs</button>
  <button class="tab" onclick="setTab('data')" id="tab-data">üíæ Backup</button>
  <button id="tab-ok" style="display:none"></button>
  <button id="tab-pending" style="display:none"></button>
</div>

<div class="stats-bar">
  <div class="stat" onclick="setTab('overdue')"><div class="stat-val red" id="stat-overdue">0</div><div class="stat-label">Overdue</div></div>
  <div class="stat" onclick="setTab('due-soon')"><div class="stat-val yellow" id="stat-soon">0</div><div class="stat-label">Due Soon</div></div>
  <div class="stat" onclick="setTab('ok')"><div class="stat-val green" id="stat-ok">0</div><div class="stat-label">On Track</div></div>
  <div class="stat" onclick="setTab('pending')"><div class="stat-val orange" id="stat-pending">0</div><div class="stat-label">Never Done</div></div>
</div>

<div class="task-list" id="taskList"></div>

<div id="techFilterBar" class="tech-filter-bar" style="display:none;">
  <span class="tech-filter-label">FILTER BY TECH:</span>
  <select id="techFilterSelect" onchange="renderHistory()">
    <option value="">All Technicians</option>
  </select>
</div>
<div class="task-list" id="historyList" style="display:none;"></div>

<div id="dataPanel" style="display:none;">
  <div class="data-panel">
    <div class="data-panel-title">‚Ñπ About</div>
    <div style="font-family:var(--font-mono);font-size:0.9rem;line-height:1.8;color:var(--text-mid);">
      <div style="font-family:var(--font-display);font-size:1.3rem;font-weight:700;color:var(--orange);letter-spacing:1px;margin-bottom:6px;">MUSTANG PM TRACKER</div>
      <div>Developed for the <span style="color:var(--text);">Coatings Department</span></div>
      <div>Built by <span style="color:var(--text);">Nick Terry</span></div>
    </div>
  </div>
  <div class="data-panel">
    <div class="data-panel-title">üìÑ PDF Report</div>
    <div class="data-btn-row">
      <button class="btn-data btn-pdf" onclick="exportPDF()">üñ® Print / Save as PDF</button>
    </div>
    <div class="data-note">Opens a printable completion history report. Use your browser's Print ‚Üí Save as PDF option to save it.</div>
  </div>
  <div class="data-panel">
    <div class="data-panel-title">üìÅ Local File Backup</div>
    <div class="data-btn-row">
      <button class="btn-data btn-export" onclick="exportData()">‚¨á Export to File</button>
      <button class="btn-data btn-import" onclick="document.getElementById('importFile').click()">‚¨Ü Import from File</button>
    </div>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    <div class="data-note">Export saves a .json backup file. Import restores from that file. Use this to move data to a new phone or as a manual safety backup.</div>
  </div>
</div>

<!-- Task completion modal -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle"></div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="modalInfo"></div>
      <div class="section-title">‚Äî Log Completion ‚Äî</div>
      <div class="complete-form">
        <div class="form-row"><label>Completed On (date)</label><input type="date" id="completionDate"></div>
        <div class="form-row"><label>Technician Name</label><input type="text" id="techName" placeholder="Enter your name"></div>
        <div class="form-row"><label>Notes (optional)</label><textarea id="completionNotes" placeholder="Any observations, issues, or comments..."></textarea></div>
        <div class="next-due-preview" id="nextDuePreview" style="display:none;"></div>
        <button class="btn-complete" onclick="logCompletion()">‚úì Mark Complete &amp; Reschedule</button>
      </div>
      <div class="section-title">‚Äî Completion History ‚Äî</div>
      <div id="historyEntries"></div>
    </div>
  </div>
</div>

<!-- Machine name modal -->
<div id="nameModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:300;align-items:center;justify-content:center;">
  <div style="background:var(--surface);border:1px solid var(--border);border-top:2px solid var(--orange);width:90%;max-width:400px;padding:20px;">
    <div style="font-family:var(--font-display);font-size:1.3rem;font-weight:700;letter-spacing:1px;margin-bottom:16px;">SET MACHINE NAME</div>
    <input type="text" id="machineNameInput" maxlength="30" placeholder="e.g. MOPM3 or Machine 1" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:var(--font-mono);font-size:1rem;outline:none;margin-bottom:12px;">
    <div style="font-family:var(--font-mono);font-size:0.88rem;color:var(--text-dim);margin-bottom:16px;">Display label only. Data stored locally on this device.</div>
    <div style="display:flex;gap:8px;">
      <button onclick="saveMachineName()" style="flex:1;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;padding:10px;cursor:pointer;">SAVE</button>
      <button onclick="document.getElementById('nameModalOverlay').style.display='none'" style="flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border);font-family:var(--font-display);font-size:1.1rem;font-weight:700;padding:10px;cursor:pointer;">CANCEL</button>
    </div>
  </div>
</div>

<!-- Manage panel -->
<div id="managePanel" style="display:none;">
  <div class="manage-panel">
    <div class="manage-section">
      <div class="manage-section-title">Custom PM Tasks</div>
      <button onclick="openAddPMModal(null)" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;letter-spacing:1px;padding:11px;cursor:pointer;margin-bottom:12px;">‚ûï ADD NEW PM TASK</button>
      <div id="customTaskList"></div>
    </div>
    <div class="manage-section">
      <div class="manage-section-title">Task Notes</div>
      <div class="form-row">
        <label>Select Task</label>
        <select id="noteTaskSelect" onchange="loadTaskNote()" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:var(--font-mono);font-size:0.9rem;outline:none;"></select>
      </div>
      <div class="form-row">
        <label>Note (shown on task card)</label>
        <textarea id="noteTextarea" placeholder="Add a note for this task..." style="min-height:80px;"></textarea>
      </div>
      <button onclick="saveTaskNote()" style="width:100%;background:var(--blue);color:white;border:none;font-family:var(--font-display);font-size:1rem;font-weight:700;padding:10px;cursor:pointer;">SAVE NOTE</button>
    </div>
  </div>
</div>

<!-- Add/Edit PM overlay -->
<div class="add-pm-overlay" id="addPMOverlay" onclick="handleAddPMClick(event)">
  <div class="add-pm-sheet">
    <div class="add-pm-header">
      <div class="add-pm-title" id="addPMTitle">ADD NEW PM TASK</div>
      <button class="modal-close" onclick="closeAddPMModal()">‚úï</button>
    </div>
    <div class="add-pm-body">
      <input type="hidden" id="pmEditId">
      <div class="form-row"><label>Task Name</label><input type="text" id="pmName" placeholder="e.g. Grease door hinges"></div>
      <div class="form-row">
        <label>Repeat Every</label>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <input type="number" id="pmAmount" value="30" min="1" style="width:80px;" oninput="updatePMPreview()">
          <select id="pmFreqType" style="flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px;font-family:var(--font-mono);font-size:0.9rem;outline:none;" onchange="updatePMPreview()">
            <option value="d">Days</option>
            <option value="w">Weeks</option>
            <option value="mo">Months</option>
            <option value="y">Years</option>
          </select>
        </div>
      </div>
      <div class="freq-preview" id="pmPreview">‚Üí Repeats every 30 days</div>
      <label id="pmAmountLabel">How many days?</label>
      <button onclick="saveCustomPM()" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.2rem;font-weight:700;padding:12px;cursor:pointer;margin-top:12px;">SAVE TASK</button>
    </div>
  </div>
</div>

<!-- Edit completion overlay -->
<div class="modal-overlay" id="editCompOverlay" onclick="if(event.target===this)closeEditComp()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Edit Completion</div>
      <button class="modal-close" onclick="closeEditComp()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editCompTaskId">
      <input type="hidden" id="editCompIndex">
      <div class="form-row"><label>Date</label><input type="date" id="editCompDate"></div>
      <div class="form-row"><label>Technician</label><input type="text" id="editCompTech" placeholder="Technician name"></div>
      <div class="form-row"><label>Notes</label><textarea id="editCompNotes" placeholder="Notes..."></textarea></div>
      <button class="btn-complete" onclick="saveEditComp()">SAVE CHANGES</button>
    </div>
  </div>
</div>

<!-- PDF overlay -->
<div id="pdfOverlay" style="display:none;position:fixed;inset:0;background:white;z-index:500;overflow:auto;padding:20px;">
  <div style="display:flex;gap:10px;margin-bottom:16px;">
    <button onclick="window.print()" style="background:#f97316;color:#000;border:none;font-weight:700;padding:10px 20px;cursor:pointer;font-size:1rem;">üñ® PRINT / SAVE PDF</button>
    <button onclick="closePDFOverlay()" style="background:#333;color:white;border:none;font-weight:700;padding:10px 20px;cursor:pointer;font-size:1rem;">‚úï CLOSE</button>
  </div>
  <div id="pdfContent"></div>
</div>

<div id="toast" class="toast"></div>

<script>
// ‚îÄ‚îÄ Task Definitions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TASKS_DEFAULT = [
  { id: 1,  name: "Check and Fill All Oil Lubricators",                  freq: "1w",  freqLabel: "1 Week"   },
  { id: 2,  name: "Check Control Panel Light Bulbs and Replace as Necessary", freq: "1w", freqLabel: "1 Week" },
  { id: 3,  name: "Inspect and Clean Glow Rod Feedthrus",                freq: "1w",  freqLabel: "1 Week"   },
  { id: 4,  name: "Check for Buildup Between Cathode Body and Chamber Wall", freq: "1w", freqLabel: "1 Week" },
  { id: 5,  name: "Check Color of Diffusion Pump Oil",                   freq: "1m",  freqLabel: "1 Month"  },
  { id: 6,  name: "Leak Check and Repair Any Leaks",                     freq: "1m",  freqLabel: "1 Month"  },
  { id: 7,  name: "Clean Electrical Control Cabinet Filter",              freq: "2m",  freqLabel: "2 Months" },
  { id: 8,  name: "Clean Chiller Supply Water Filter",                   freq: "2m",  freqLabel: "2 Months" },
  { id: 9,  name: "Remove, Clean, and Lubricate Vent Valve Piston",      freq: "2m",  freqLabel: "2 Months" },
  { id: 10, name: "Clean and Calibrate Chamber Gauge",                   freq: "3m",  freqLabel: "3 Months" },
  { id: 11, name: "Clean and Calibrate Foreline Gauge",                  freq: "3m",  freqLabel: "3 Months" },
  { id: 12, name: "Clean and Calibrate Roughing Line Gauge",             freq: "3m",  freqLabel: "3 Months" },
  { id: 13, name: "Lubricate Door Ball Screw",                           freq: "3m",  freqLabel: "3 Months" },
  { id: 14, name: "Replace Door Seal",                                   freq: "6m",  freqLabel: "6 Months" },
  { id: 15, name: "Replace High Vac Cylinder Seal",                      freq: "6m",  freqLabel: "6 Months" },
  { id: 16, name: "Replace Seal on Poppet Cylinder Shaft",               freq: "6m",  freqLabel: "6 Months" },
  { id: 17, name: "Change Demist Filters",                               freq: "1y",  freqLabel: "1 Year"   },
  { id: 18, name: "Check Belt Tension on Mechanical Pumps",              freq: "1y",  freqLabel: "1 Year"   },
  { id: 19, name: "Check Bushings to Ensure Belt Pulleys Have Not Moved on Mechanical Pumps", freq: "1y", freqLabel: "1 Year" },
];

// ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadState() { try { const r = localStorage.getItem('mustangpm_state'); return r ? JSON.parse(r) : {}; } catch(e) { return {}; } }
function saveState(s) { localStorage.setItem('mustangpm_state', JSON.stringify(s)); }
function loadCustomTasks() { try { const r = localStorage.getItem('mustangpm_custom'); return r ? JSON.parse(r) : []; } catch(e) { return []; } }
function saveCustomTasks() { localStorage.setItem('mustangpm_custom', JSON.stringify(customTasks)); }
function loadTaskNotes() { try { return JSON.parse(localStorage.getItem('mustangpm_notes') || '{}'); } catch(e) { return {}; } }
function saveTaskNotes(n) { localStorage.setItem('mustangpm_notes', JSON.stringify(n)); }
function getTaskNote(taskId) { return loadTaskNotes()[taskId] || ''; }
function getAllTasks() { return [...TASKS_DEFAULT, ...customTasks]; }

let state = loadState();
let customTasks = loadCustomTasks();
let currentTab = 'all';
let currentTaskId = null;

// ‚îÄ‚îÄ Date Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function today() { return new Date().toISOString().slice(0, 10); }
function dateFromStr(s) { const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); }
function strFromDate(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
function formatDate(dateStr) {
  const [y,m,d] = dateStr.split('-');
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1] + ' ' + parseInt(d) + ', ' + y;
}
function daysDiff(dateStr) { return Math.round((dateFromStr(dateStr) - dateFromStr(today())) / 86400000); }

function calcNextDue(fromDateStr, freq) {
  if (/^\d+(d|w|mo|y)$/.test(freq)) return calcNextDueCustom(fromDateStr, freq);
  const d = dateFromStr(fromDateStr); const day = d.getDate(); let y = d.getFullYear(); let m = d.getMonth();
  if (freq === '1w') { d.setDate(day + 7); return strFromDate(d); }
  const addMonths = (n) => { m += n; if (m > 11) { y += Math.floor(m/12); m = m%12; } const mx = new Date(y,m+1,0).getDate(); return `${y}-${String(m+1).padStart(2,'0')}-${String(Math.min(day,mx)).padStart(2,'0')}`; };
  if (freq === '1m') return addMonths(1);
  if (freq === '2m') return addMonths(2);
  if (freq === '3m') return addMonths(3);
  if (freq === '6m') return addMonths(6);
  if (freq === '1y') { y += 1; const mx = new Date(y,m+1,0).getDate(); return `${y}-${String(m+1).padStart(2,'0')}-${String(Math.min(day,mx)).padStart(2,'0')}`; }
  return fromDateStr;
}
function calcNextDueCustom(fromDateStr, freq) {
  const m = freq.match(/^(\d+)(d|w|mo|y)$/); if (!m) return fromDateStr;
  const n = parseInt(m[1]), t = m[2];
  const d = new Date(fromDateStr + 'T00:00:00');
  if (t==='d') d.setDate(d.getDate()+n);
  else if (t==='w') d.setDate(d.getDate()+n*7);
  else if (t==='mo') d.setMonth(d.getMonth()+n);
  else if (t==='y') d.setFullYear(d.getFullYear()+n);
  return d.toISOString().slice(0,10);
}
function freqTotalDays(freq) {
  if (freq==='1w') return 7; if (freq==='1m') return 30; if (freq==='2m') return 60;
  if (freq==='3m') return 90; if (freq==='6m') return 180; if (freq==='1y') return 365;
  const m = freq.match(/^(\d+)(d|w|mo|y)$/); if (!m) return 30;
  const n=parseInt(m[1]),t=m[2];
  if (t==='d') return n; if (t==='w') return n*7; if (t==='mo') return n*30; if (t==='y') return n*365;
  return 30;
}
function getStatus(task) {
  const ts = state[task.id]; if (!ts || !ts.nextDue) return 'pending';
  const diff = daysDiff(ts.nextDue); if (diff < 0) return 'overdue';
  const total = freqTotalDays(task.freq);
  const soonDays = total <= 7 ? 3 : total <= 60 ? 7 : total <= 180 ? 14 : 30;
  return diff <= soonDays ? 'due-soon' : 'ok';
}
function buildFreqCode(type, amount) { return amount + type; }
function freqCodeToLabel(freq) {
  const m = freq.match(/^(\d+)(d|w|mo|y)$/); if (!m) return freq;
  const n=m[1],t=m[2];
  if (t==='d') return n+' Day'+(n==='1'?'':'s');
  if (t==='w') return n+' Week'+(n==='1'?'':'s');
  if (t==='mo') return n+' Month'+(n==='1'?'':'s');
  if (t==='y') return n+' Year'+(n==='1'?'':'s');
  return freq;
}

// ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  setTimeout(() => { t.className = 'toast'; }, 3000);
}
function toggleLightMode() {
  const isLight = document.body.classList.toggle('light-mode');
  localStorage.setItem('mustangpm_lightmode', isLight ? '1' : '0');
  document.getElementById('lightToggleBtn').textContent = isLight ? 'üåô' : '‚òÄ';
}
const _fontSizes = ['normal','lg','xl'];
let _currentFont = localStorage.getItem('mustangpm_fontsize') || 'normal';
function applyFontSize(s) {
  document.documentElement.style.fontSize = s==='xl' ? '20px' : s==='lg' ? '17px' : '15px';
  const btn = document.getElementById('fontSizeBtn');
  btn.textContent = s==='xl' ? 'A++' : s==='lg' ? 'A+' : 'A';
  btn.style.fontSize = s==='xl' ? '0.75rem' : s==='lg' ? '0.9rem' : '1.2rem';
  _currentFont = s; localStorage.setItem('mustangpm_fontsize', s);
}
function cycleFontSize() { applyFontSize(_fontSizes[(_fontSizes.indexOf(_currentFont)+1)%_fontSizes.length]); }
function editMachineName() {
  document.getElementById('machineNameInput').value = localStorage.getItem('mustangpm_machinename') || '';
  document.getElementById('nameModalOverlay').style.display = 'flex';
  setTimeout(() => document.getElementById('machineNameInput').focus(), 100);
}
function saveMachineName() {
  const val = document.getElementById('machineNameInput').value.trim();
  if (!val) { showToast('Please enter a machine name', 'error'); return; }
  localStorage.setItem('mustangpm_machinename', val);
  document.getElementById('machineNameDisplay').textContent = val;
  document.getElementById('nameModalOverlay').style.display = 'none';
  showToast('‚úì Machine name saved', 'success');
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
  let overdue=0, soon=0, ok=0, pending=0;
  getAllTasks().forEach(t => { const s=getStatus(t); if(s==='overdue') overdue++; else if(s==='due-soon') soon++; else if(s==='ok') ok++; else pending++; });
  document.getElementById('stat-overdue').textContent = overdue;
  document.getElementById('stat-soon').textContent = soon;
  document.getElementById('stat-ok').textContent = ok;
  document.getElementById('stat-pending').textContent = pending;
  const badge = document.getElementById('globalOverdueBadge');
  if (overdue > 0) { badge.style.display = 'block'; badge.textContent = overdue + ' OVERDUE'; } else badge.style.display = 'none';
  const ob = document.getElementById('badge-overdue'); const sb = document.getElementById('badge-soon');
  if (overdue > 0) { ob.textContent = overdue; ob.style.display = 'inline'; } else ob.style.display = 'none';
  if (soon > 0) { sb.textContent = soon; sb.style.display = 'inline'; } else sb.style.display = 'none';
  document.title = overdue > 0 ? `(${overdue} OVERDUE) Mustang PM Tracker` : 'Mustang PM Tracker';
}

// ‚îÄ‚îÄ Tab / Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('tab-' + tab); if (el) el.classList.add('active');
  renderAll();
}

function renderAll() {
  updateStats();
  document.getElementById('taskList').style.display = 'none';
  document.getElementById('historyList').style.display = 'none';
  document.getElementById('dataPanel').style.display = 'none';
  document.getElementById('managePanel').style.display = 'none';
  document.getElementById('techFilterBar').style.display = 'none';
  if (currentTab === 'history') { renderHistory(); return; }
  if (currentTab === 'data') { document.getElementById('dataPanel').style.display = 'block'; return; }
  if (currentTab === 'manage') { document.getElementById('managePanel').style.display = 'block'; renderManagePanel(); return; }

  const taskList = document.getElementById('taskList');
  taskList.style.display = '';
  let tasks = getAllTasks();
  if (currentTab === 'overdue') tasks = tasks.filter(t => getStatus(t) === 'overdue');
  else if (currentTab === 'due-soon') tasks = tasks.filter(t => getStatus(t) === 'due-soon');
  else if (currentTab === 'ok') tasks = tasks.filter(t => getStatus(t) === 'ok');
  else if (currentTab === 'pending') tasks = tasks.filter(t => getStatus(t) === 'pending');

  if (currentTab === 'by-date') {
    tasks.sort((a,b) => (state[a.id]?.nextDue||'9999-99-99').localeCompare(state[b.id]?.nextDue||'9999-99-99'));
  } else {
    const so = {overdue:0,'due-soon':1,ok:2,pending:3};
    tasks.sort((a,b) => {
      const d = so[getStatus(a)] - so[getStatus(b)]; if (d!==0) return d;
      return (state[a.id]?.nextDue||'9999-99-99').localeCompare(state[b.id]?.nextDue||'9999-99-99');
    });
  }

  if (tasks.length === 0) { taskList.innerHTML = '<div class="empty-state">‚úì No tasks in this category</div>'; return; }
  taskList.innerHTML = '';
  let lastFreq = null, lastDivDate = null;

  tasks.forEach(task => {
    if (currentTab === 'all' && task.freqLabel !== lastFreq) {
      lastFreq = task.freqLabel;
      const div = document.createElement('div'); div.className = 'freq-divider'; div.textContent = '‚Äî ' + task.freqLabel + ' ‚Äî'; taskList.appendChild(div);
    }
    if (currentTab === 'by-date') {
      const lbl = state[task.id]?.nextDue ? formatDate(state[task.id].nextDue) : 'Never Completed';
      if (lbl !== lastDivDate) { lastDivDate = lbl; const div = document.createElement('div'); div.className = 'freq-divider'; div.textContent = '‚Äî ' + lbl + ' ‚Äî'; taskList.appendChild(div); }
    }

    const status = getStatus(task); const ts = state[task.id];
    const histCount = ts?.history?.length || 0;
    const lastTech = ts?.history?.length ? ts.history[ts.history.length-1].tech : '';
    const taskNote = getTaskNote(task.id);
    const isCritical = status === 'overdue' && ts?.nextDue && Math.abs(daysDiff(ts.nextDue)) >= freqTotalDays(task.freq);
    let dueText='', dueClass='', tagHtml='';

    if (status === 'pending') {
      dueText = 'Never completed ‚Äî needs initial service'; dueClass = 'orange';
      tagHtml = '<span class="task-status-tag tag-pending">PENDING</span>';
    } else {
      const diff = daysDiff(ts.nextDue);
      if (status === 'overdue') {
        dueText = `OVERDUE by ${Math.abs(diff)} day${Math.abs(diff)===1?'':'s'} ‚Äî was due ${formatDate(ts.nextDue)}`;
        dueClass = 'red';
        tagHtml = isCritical ? '<span class="task-status-tag tag-critical">‚ö† CRITICAL</span>' : '<span class="task-status-tag tag-overdue">OVERDUE</span>';
      } else if (status === 'due-soon') {
        dueText = diff===0 ? `Due TODAY ‚Äî ${formatDate(ts.nextDue)}` : `Due in ${diff} day${diff===1?'':'s'} ‚Äî ${formatDate(ts.nextDue)}`;
        dueClass = 'yellow'; tagHtml = '<span class="task-status-tag tag-soon">DUE SOON</span>';
      } else {
        dueText = `Next due: ${formatDate(ts.nextDue)} (in ${diff} days)`;
        dueClass = 'green'; tagHtml = '<span class="task-status-tag tag-ok">ON TRACK</span>';
      }
    }

    const ablogOverdue = status === 'overdue' ? `<div style="margin-top:8px;background:#3a0000;border:2px solid #ff0000;padding:8px 10px;font-family:var(--font-mono);font-size:0.92rem;color:#ff4444;line-height:1.5;">üö® Document in the Ablog immediately per NAL policy and complete PM ASAP.</div>` : '';
    const ablogSoon = (status === 'due-soon' && daysDiff(ts?.nextDue) <= 2) ? `<div style="margin-top:8px;background:var(--yellow-dim);border:1px solid var(--yellow);padding:6px 10px;font-family:var(--font-mono);font-size:0.88rem;color:var(--yellow);line-height:1.5;">‚ö† Due within 2 days ‚Äî if not completed on time, document in the Ablog per NAL policy.</div>` : '';

    const card = document.createElement('div');
    card.className = `task-card ${isCritical ? 'critical' : (status==='pending' ? 'never-done' : status)}`;
    card.innerHTML = `
      <div class="task-top"><div class="task-name">${task.name}</div><div class="task-freq">${task.freqLabel}</div></div>
      <div class="task-bottom">
        <div>
          <div class="history-count">${histCount>0 ? `${histCount} completion${histCount===1?'':'s'} logged` : 'No history yet'}</div>
          ${lastTech ? `<div class="last-tech">Last: ${lastTech}</div>` : ''}
          <div class="task-due ${dueClass}">${dueText}</div>
          ${taskNote ? `<div class="task-note-badge">üìå ${taskNote}</div>` : ''}
        </div>
        ${tagHtml}
      </div>
      ${ablogOverdue}${ablogSoon}`;
    card.onclick = () => openModal(task.id);
    taskList.appendChild(card);
  });
}

function renderHistory() {
  const hl = document.getElementById('historyList'); hl.style.display = '';
  document.getElementById('techFilterBar').style.display = 'flex';
  const techSet = new Set();
  getAllTasks().forEach(task => { const ts = state[task.id]; if (ts?.history) ts.history.forEach(h => { if (h.tech) techSet.add(h.tech); }); });
  const sel = document.getElementById('techFilterSelect');
  const currentFilter = sel.value;
  sel.innerHTML = '<option value="">All Technicians</option>' + [...techSet].sort().map(t => `<option value="${t}" ${t===currentFilter?'selected':''}>${t}</option>`).join('');
  const filterTech = sel.value;
  let entries = [];
  getAllTasks().forEach(task => { const ts = state[task.id]; if (ts?.history) ts.history.forEach((h,idx) => { if (!filterTech || h.tech===filterTech) entries.push({...h, taskId: task.id, taskName: task.name, idx}); }); });
  entries.sort((a,b) => b.date.localeCompare(a.date));
  if (entries.length === 0) { hl.innerHTML = '<div class="empty-state">No completed tasks yet.</div>'; return; }
  hl.innerHTML = entries.map(e => `
    <div class="history-entry">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="history-date">‚úì ${formatDate(e.date)}</div>
          <div class="history-tech" style="font-weight:600;color:var(--text);">${e.taskName}</div>
          <div class="history-tech">Tech: ${e.tech||'Not specified'}</div>
          ${e.notes ? `<div class="history-notes">"${e.notes}"</div>` : ''}
        </div>
        <button class="history-edit-btn" onclick="openEditComp('${e.taskId}',${e.idx})">EDIT</button>
      </div>
    </div>`).join('');
}

function renderManagePanel() {
  const el = document.getElementById('customTaskList');
  if (!customTasks.length) {
    el.innerHTML = '<div style="font-family:var(--font-mono);font-size:0.85rem;color:var(--text-dim);text-align:center;padding:16px;">No custom tasks yet.</div>';
  } else {
    el.innerHTML = customTasks.map(t => `
      <div class="custom-task-item">
        <div class="custom-task-info">
          <div class="custom-task-name">${t.name}</div>
          <div class="custom-task-freq">Every ${t.freqLabel}</div>
        </div>
        <div class="custom-task-btns">
          <button class="btn-edit" onclick="openAddPMModal('${t.id}')">EDIT</button>
          <button class="btn-del" onclick="deleteCustomPM('${t.id}')">DEL</button>
        </div>
      </div>`).join('');
  }
  const noteSelect = document.getElementById('noteTaskSelect');
  noteSelect.innerHTML = getAllTasks().map(t => `<option value="${t.id}">${t.name}</option>`).join('');
  loadTaskNote();
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(taskId) {
  currentTaskId = taskId;
  const task = getAllTasks().find(t => String(t.id) === String(taskId));
  const ts = state[taskId];
  document.getElementById('modalTitle').textContent = task.name;
  document.getElementById('completionDate').value = today();
  document.getElementById('techName').value = localStorage.getItem('lastTechName') || '';
  document.getElementById('completionNotes').value = '';
  document.getElementById('modalInfo').innerHTML = `
    <div class="modal-info-row"><span class="info-label">Frequency</span><span class="info-value">${task.freqLabel}</span></div>
    <div class="modal-info-row"><span class="info-label">Next Due</span><span class="info-value">${ts?.nextDue ? formatDate(ts.nextDue) : 'Never completed'}</span></div>
    <div class="modal-info-row"><span class="info-label">Status</span><span class="info-value">${{overdue:'üî¥ OVERDUE','due-soon':'üü° DUE SOON',ok:'üü¢ ON TRACK',pending:'üü† NEVER DONE'}[getStatus(task)]}</span></div>`;
  const history = ts?.history || [];
  const container = document.getElementById('historyEntries');
  if (history.length === 0) {
    container.innerHTML = '<div class="no-history">No history yet for this task.</div>';
  } else {
    const sorted = [...history].sort((a,b) => b.date.localeCompare(a.date));
    container.innerHTML = sorted.map(h => `
      <div class="history-entry">
        <div class="history-date">‚úì ${formatDate(h.date)}</div>
        <div class="history-tech">Tech: ${h.tech||'Not specified'}</div>
        ${h.notes ? `<div class="history-notes">"${h.notes}"</div>` : ''}
      </div>`).join('');
  }
  updateNextDuePreview();
  document.getElementById('completionDate').addEventListener('change', updateNextDuePreview);
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function updateNextDuePreview() {
  const task = getAllTasks().find(t => String(t.id) === String(currentTaskId));
  const dateVal = document.getElementById('completionDate').value; if (!dateVal) return;
  const preview = document.getElementById('nextDuePreview');
  preview.style.display = 'block'; preview.textContent = `‚Üí Next due will be set to: ${formatDate(calcNextDue(dateVal, task.freq))}`;
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); document.body.style.overflow = ''; currentTaskId = null; }
function handleOverlayClick(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

function logCompletion() {
  const task = getAllTasks().find(t => String(t.id) === String(currentTaskId));
  const dateVal = document.getElementById('completionDate').value;
  const tech = document.getElementById('techName').value.trim();
  const notes = document.getElementById('completionNotes').value.trim();
  if (!dateVal) { alert('Please select a completion date.'); return; }
  const nextDue = calcNextDue(dateVal, task.freq);
  if (!state[currentTaskId]) state[currentTaskId] = { nextDue: null, history: [] };
  state[currentTaskId].nextDue = nextDue;
  state[currentTaskId].history.push({ date: dateVal, tech, notes });
  if (tech) localStorage.setItem('lastTechName', tech);
  saveState(state); closeModal(); renderAll();
  showToast('‚úì Logged! Next due: ' + formatDate(nextDue), 'success');
}

// ‚îÄ‚îÄ Custom PMs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddPMModal(taskId) {
  document.getElementById('pmEditId').value = taskId || '';
  if (taskId) {
    const t = customTasks.find(t => t.id === taskId);
    document.getElementById('addPMTitle').textContent = 'EDIT PM TASK';
    document.getElementById('pmName').value = t.name;
    const m = t.freq.match(/^(\d+)(d|w|mo|y)$/);
    if (m) { document.getElementById('pmFreqType').value = m[2]; document.getElementById('pmAmount').value = m[1]; }
  } else {
    document.getElementById('addPMTitle').textContent = 'ADD NEW PM TASK';
    document.getElementById('pmName').value = '';
    document.getElementById('pmFreqType').value = 'd';
    document.getElementById('pmAmount').value = '30';
  }
  updatePMPreview();
  document.getElementById('addPMOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeAddPMModal() { document.getElementById('addPMOverlay').classList.remove('open'); document.body.style.overflow = ''; }
function handleAddPMClick(e) { if (e.target === document.getElementById('addPMOverlay')) closeAddPMModal(); }
function updatePMPreview() {
  const type = document.getElementById('pmFreqType').value;
  const amount = document.getElementById('pmAmount').value || 1;
  const labels = {d:'days',w:'weeks',mo:'months',y:'years'};
  document.getElementById('pmAmountLabel').textContent = 'How many ' + labels[type] + '?';
  document.getElementById('pmPreview').textContent = '‚Üí Repeats every ' + amount + ' ' + labels[type];
}
function saveCustomPM() {
  const name = document.getElementById('pmName').value.trim();
  if (!name) { showToast('Please enter a task name', 'error'); return; }
  const freq = buildFreqCode(document.getElementById('pmFreqType').value, document.getElementById('pmAmount').value || 1);
  const editId = document.getElementById('pmEditId').value;
  if (editId) {
    const idx = customTasks.findIndex(t => t.id === editId);
    if (idx !== -1) customTasks[idx] = { ...customTasks[idx], name, freq, freqLabel: freqCodeToLabel(freq) };
  } else {
    customTasks.push({ id: 'c_' + Date.now(), name, freq, freqLabel: freqCodeToLabel(freq), custom: true });
  }
  saveCustomTasks(); closeAddPMModal(); renderManagePanel(); renderAll();
  showToast(editId ? '‚úì Task updated' : '‚úì New PM task added', 'success');
}
function deleteCustomPM(taskId) {
  if (!confirm('Delete this task? Its history will also be removed.')) return;
  customTasks = customTasks.filter(t => t.id !== taskId);
  delete state[taskId];
  saveCustomTasks(); saveState(state); renderManagePanel(); renderAll();
  showToast('Task deleted', 'success');
}

// ‚îÄ‚îÄ Task Notes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadTaskNote() {
  const id = document.getElementById('noteTaskSelect').value;
  document.getElementById('noteTextarea').value = getTaskNote(id);
}
function saveTaskNote() {
  const id = document.getElementById('noteTaskSelect').value;
  const text = document.getElementById('noteTextarea').value.trim();
  const notes = loadTaskNotes();
  if (text) notes[id] = text; else delete notes[id];
  saveTaskNotes(notes); renderAll();
  showToast(text ? '‚úì Note saved' : '‚úì Note removed', 'success');
}

// ‚îÄ‚îÄ Edit Completion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditComp(taskId, idx) {
  const ts = state[taskId]; if (!ts?.history?.[idx]) return;
  const h = ts.history[idx];
  document.getElementById('editCompTaskId').value = taskId;
  document.getElementById('editCompIndex').value = idx;
  document.getElementById('editCompDate').value = h.date;
  document.getElementById('editCompTech').value = h.tech || '';
  document.getElementById('editCompNotes').value = h.notes || '';
  document.getElementById('editCompOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeEditComp() { document.getElementById('editCompOverlay').classList.remove('open'); document.body.style.overflow = ''; }
function saveEditComp() {
  const taskId = document.getElementById('editCompTaskId').value;
  const idx = parseInt(document.getElementById('editCompIndex').value);
  const date = document.getElementById('editCompDate').value;
  const tech = document.getElementById('editCompTech').value.trim();
  const notes = document.getElementById('editCompNotes').value.trim();
  if (!date) { showToast('Please select a date', 'error'); return; }
  state[taskId].history[idx] = { date, tech, notes };
  const sorted = [...state[taskId].history].sort((a,b) => b.date.localeCompare(a.date));
  const task = getAllTasks().find(t => String(t.id) === String(taskId));
  if (task) state[taskId].nextDue = calcNextDue(sorted[0].date, task.freq);
  saveState(state); closeEditComp(); renderHistory();
  showToast('‚úì Completion updated', 'success');
}

// ‚îÄ‚îÄ Export / Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), state, custom: customTasks, notes: loadTaskNotes() }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `mustang-pm-backup-${today()}.json`; a.click();
  URL.revokeObjectURL(url);
  showToast('‚úì Backup file downloaded', 'success');
}
function importData(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.state) { showToast('Invalid backup file', 'error'); return; }
      state = data.state; saveState(state);
      if (data.custom) { customTasks = data.custom; saveCustomTasks(); }
      if (data.notes) saveTaskNotes(data.notes);
      showToast('‚úì Data restored from backup', 'success'); renderAll();
    } catch(err) { showToast('Failed to read file', 'error'); }
  };
  reader.readAsText(file); event.target.value = '';
}

// ‚îÄ‚îÄ PDF Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportPDF() {
  const machineName = localStorage.getItem('mustangpm_machinename') || 'Unknown Machine';
  let entries = [];
  getAllTasks().forEach(task => { const ts = state[task.id]; if (ts?.history) ts.history.forEach(h => entries.push({...h, taskName: task.name})); });
  entries.sort((a,b) => b.date.localeCompare(a.date));
  const rows = entries.map((e,i) => `<tr style="background:${i%2===0?'#fff':'#f9f9f9'}">
    <td style="padding:10px 8px;border-bottom:1px solid #ddd;font-size:0.95rem;">${formatDate(e.date)}</td>
    <td style="padding:10px 8px;border-bottom:1px solid #ddd;font-size:0.95rem;">${e.taskName}</td>
    <td style="padding:10px 8px;border-bottom:1px solid #ddd;font-size:0.95rem;">${e.tech||'‚Äî'}</td>
    <td style="padding:10px 8px;border-bottom:1px solid #ddd;font-size:0.95rem;">${e.notes||'‚Äî'}</td>
  </tr>`).join('');
  document.getElementById('pdfContent').innerHTML = `
    <div style="font-size:1.2rem;font-weight:bold;color:#e06010;margin-bottom:4px;">MOPM ‚Äî ${machineName}</div>
    <div style="color:#555;font-size:0.9rem;margin-bottom:16px;">Generated: ${new Date().toLocaleDateString()} &nbsp;|&nbsp; ${entries.length} total completions</div>
    <table style="width:100%;border-collapse:collapse;">
      <thead><tr>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;">Date</th>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;">Task</th>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;">Technician</th>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;">Notes</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  document.getElementById('pdfOverlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closePDFOverlay() { document.getElementById('pdfOverlay').style.display = 'none'; document.body.style.overflow = ''; }

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('completionDate').value = today();
const _machineName = localStorage.getItem('mustangpm_machinename') || '';
document.getElementById('machineNameDisplay').textContent = _machineName || 'TAP TO NAME ‚úé';
if (localStorage.getItem('mustangpm_lightmode') === '1') {
  document.body.classList.add('light-mode');
  document.getElementById('lightToggleBtn').textContent = 'üåô';
}
applyFontSize(_currentFont);
renderAll();
</script>
</body>
</html>
